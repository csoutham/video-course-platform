# 31. Course Completion Certificates (v1 Plan)

## Summary

Add course completion certificates as a learner-facing achievement record.

In v1, an eligible learner can download a generated PDF certificate once they reach 100% completed lessons for a
course. Each certificate uses an admin-uploaded template PDF with centered text overlay and includes a public
verification URL/code. Full refunds revoke certificates; partial refunds do not.

## Locked Decisions

1. Eligibility threshold: 100% completed published lessons for the course.
2. Generation model: uploaded template PDF + server-side text overlay.
3. Verification model: public verify URL/code.
4. Name policy: issued learner name is snapshotted and immutable.
5. Refund policy: full refund revokes certificate.
6. Issuance timing: lazy issuance on first successful certificate download request.
7. Certificate cardinality: one certificate per learner per course in v1.

## Scope

### In scope

1. Admin course-level certificate settings.
2. Template PDF upload per course (single-page template usage).
3. Learner certificate download route.
4. Public verification page.
5. Issuance persistence with immutable snapshots.
6. Webhook revocation integration for full refunds.
7. Pest feature/unit tests.

### Out of scope

1. Multi-template variants per course.
2. Drag/drop template coordinate editor.
3. PKI-signed PDF certificates.
4. Batch retroactive issuance jobs.
5. Multi-language certificate copy variants.

## Public Interfaces and Routes

### Learner routes

1. `GET /my-courses/{course:slug}/certificate` (`certificates.show`)
    - auth required.
    - entitlement/subscription + eligibility required.
    - streams PDF certificate when active.
2. `GET /certificates/verify/{code}` (`certificates.verify`)
    - public verification endpoint with active/revoked status.

### Admin routes

1. `GET /admin/courses/{course}/certificate` (`admin.courses.certificate.edit`)
2. `PUT /admin/courses/{course}/certificate` (`admin.courses.certificate.update`)

## Data Model

### New table: `course_certificates`

- `id`
- `user_id` (FK, index)
- `course_id` (FK, index)
- `order_id` (nullable FK, index)
- `subscription_id` (nullable FK, index)
- `public_id` (unique, obfuscated)
- `verification_code` (unique)
- `issued_name` (string)
- `issued_course_title` (string)
- `issued_at` (datetime)
- `status` enum: `active|revoked`
- `revoked_at` (nullable datetime)
- `revoke_reason` (nullable string)
- `template_version` (nullable string)
- timestamps

Constraints:

1. Unique (`user_id`, `course_id`) in v1.
2. Unique `public_id`.
3. Unique `verification_code`.

### Course settings fields

Add to `courses`:

- `certificate_enabled` bool default false
- `certificate_template_path` nullable string
- `certificate_signatory_name` nullable string
- `certificate_signatory_title` nullable string

## Generation Architecture

### Libraries

1. `setasign/fpdf`
2. `setasign/fpdi`

### Flow

1. Resolve uploaded template PDF from configured storage disk.
2. Import first page via FPDI.
3. Overlay centered text:
    - learner issued name
    - fixed completion line
    - course title snapshot
    - issue date
    - verification URL/code
    - optional signatory line
4. Stream PDF to learner.
5. Optional: cache generated bytes by certificate id + template version.

## Eligibility, Issuance, and Access Rules

1. Learner must be authenticated.
2. Learner must have access using existing course access service.
3. Course must be published and certificate-enabled.
4. All published lessons in course must be completed.
5. Certificate is created once and reused on subsequent downloads.
6. Revoked certificates are not downloadable.

## Revocation Rules

1. Full refund (`amount_refunded >= amount`) revokes linked certificate(s).
2. Partial refund does not revoke certificate.
3. Verification page reflects `revoked` status with revoke timestamp/reason.

## Admin UX Plan

Add certificate panel to course admin experience:

1. Enable/disable certificates.
2. Upload/replace template PDF (max 10MB).
3. Optional signatory name/title.
4. Save validation and safe replacement cleanup of old template file.
5. Display current template file metadata.
6. Include helper text for template safe center zone.

## Security Controls

1. Verification codes are random, non-sequential.
2. Public verification exposes minimal data only.
3. Download remains auth-gated and policy-gated.
4. Public verify endpoint is rate limited.
5. Issued name is sanitized/trimmed and snapshotted.

## Testing Plan (Pest)

### Feature tests

1. Eligible learner can download certificate.
2. Ineligible learner (<100% completion) is blocked.
3. Unentitled learner is blocked.
4. First successful download creates one issuance record only.
5. Verify URL resolves active certificate.
6. Full refund webhook revokes certificate.
7. Partial refund webhook leaves certificate active.
8. Revoked certificate can no longer be downloaded.

### Unit tests

1. Eligibility service calculation edge cases.
2. PDF render service non-empty output and template import.
3. Verification code/public id generation uniqueness behavior.

## Rollout

1. Ship behind `CERTIFICATES_ENABLED=false`.
2. Deploy schema/services/routes with flag off.
3. Configure template for test course in staging.
4. Validate learner issuance + verify URL + refund revocation.
5. Enable in production after webhook and QA checks.

## Acceptance Criteria

1. Admin can enable certificates per course and upload template PDF.
2. Learner at 100% completion can download a certificate.
3. Certificate contains learner snapshot name, course title snapshot, issue date, and verification code/url.
4. Public verify endpoint confirms active/revoked status.
5. Full refund revokes certificate; partial refund does not.
6. Existing checkout, entitlement, progress, receipts, and review flows remain functional.
